name: Generate docs index

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate nodes_index.json
        run: |
          python - << 'PY'
          import os, json, re

          ROOT = "n8n_docs_final"
          OUT_DIR = "indexes"
          OUT_FILE = os.path.join(OUT_DIR, "nodes_index.json")

          def norm_key(path: str) -> str:
            base = os.path.basename(path)
            base = re.sub(r"\.md$", "", base, flags=re.I)
            base = re.sub(r"[^a-zA-Z0-9]+", "_", base).strip("_").lower()
            return base

          def keywords_from_filename(path: str):
            base = os.path.basename(path)
            base = re.sub(r"\.md$", "", base, flags=re.I)
            parts = re.split(r"[_\-\s]+", base.lower())
            parts = [p for p in parts if p and len(p) > 2]
            # de-dup but preserve order
            seen = set()
            out = []
            for p in parts:
              if p not in seen:
                seen.add(p)
                out.append(p)
            return out[:12]

          index = {}

          for dirpath, _, filenames in os.walk(ROOT):
            for fn in filenames:
              if not fn.lower().endswith(".md"):
                continue
              full = os.path.join(dirpath, fn).replace("\\", "/")
              key = norm_key(full)

              # avoid accidental overwrites
              if key in index:
                suffix = norm_key(dirpath)
                key = f"{key}__{suffix}"

              index[key] = {
                "file": full,
                "keywords": keywords_from_filename(full)
              }

          os.makedirs(OUT_DIR, exist_ok=True)
          with open(OUT_FILE, "w", encoding="utf-8") as f:
            json.dump(index, f, ensure_ascii=False, indent=2)

          print(f"Wrote {OUT_FILE} with {len(index)} entries")
          PY

      - name: Commit index
        run: |
          if git status --porcelain | grep -q "indexes/nodes_index.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add indexes/nodes_index.json
            git commit -m "Update docs index"
            git push
          else
            echo "No changes to commit"
          fi
